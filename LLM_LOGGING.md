# LLM 调用日志详细记录

## 概述

已为所有大模型（LLM）调用添加了详细的日志记录，包括：
1. ✅ 发送给 LLM 的完整提示词（Prompt）
2. ✅ LLM 返回的完整响应（Response）
3. ✅ 对话历史上下文（Conversation Context）

## 日志格式

### 1. 对话历史构建日志

**位置**: `backend/app/core/session.py:178-260`

**日志格式**:
```
================================================================================
📚 CONVERSATION HISTORY - Building Context for LLM
================================================================================
Session ID: f7f92f0e-9a00-4ca5-a83b-0e88dbf2a7f5
Total turns: 2
Current input: 中等消费偏好的就可以
--------------------------------------------------------------------------------
📜 History Summary (last 10 turns):
第1轮:
  用户输入: 我想为春季新款手袋策划营销活动，2000人以内
  业务目标: 提升春季新款手袋转化率
  KPI目标: conversion_rate
  目标人群: {...}
  约束条件: 无
  圈选人数: 150人

第2轮:
  ...
--------------------------------------------------------------------------------
📌 Latest Intent:
{
  "business_goal": "提升春季新款手袋转化率",
  "target_audience": {...},
  "constraints": [],
  "kpi": "conversion_rate",
  "size_preference": {"min": "", "max": "2000"}
}
--------------------------------------------------------------------------------
📋 Accumulated Constraints (0 total):
--------------------------------------------------------------------------------
📦 FINAL CONTEXT TO BE SENT TO LLM:
## 对话历史
...
================================================================================
```

### 2. Intent Recognition Node 日志

**位置**: `backend/app/agent/nodes.py:112-134`

**日志格式**:
```
================================================================================
🤖 LLM CALL - Intent Recognition Node
================================================================================
Multi-turn mode: True
Previous intent: {
  "business_goal": "提升春季新款手袋转化率",
  "target_audience": {...},
  "constraints": [],
  "kpi": "conversion_rate",
  "size_preference": {"min": "", "max": "2000"}
}
--------------------------------------------------------------------------------
📝 PROMPT TO LLM:
## 对话历史
...

**多轮对话模式 - 重要**：
这是一个多轮对话。上一轮我们已经识别出的意图是：

```json
{
  "business_goal": "提升春季新款手袋转化率",
  ...
}
```

现在用户提供了新的输入："中等消费偏好的就可以"

**你的任务**：
1. **以上一轮意图为基线**：如果新输入没有提到某个字段（如business_goal、kpi），保留上一轮的值
2. **累积约束条件**：将新的约束条件追加到constraints列表中
...

你是一个营销专家，负责分析用户的圈人需求。

**重要提醒**：这是多轮对话，你必须在上一轮意图的基础上进行增量更新，而不是从零开始。

请分析用户的新输入，并更新意图，并返回JSON格式的结果...
--------------------------------------------------------------------------------
📥 LLM RESPONSE:
{
  "business_goal": "提升春季新款手袋转化率",
  "target_audience": {
    "tier": [],
    "age_group": "",
    "gender": "",
    "consumption_preference": "中等"
  },
  "constraints": [],
  "kpi": "conversion_rate",
  "size_preference": {"min": "", "max": "2000"},
  "is_clear": true,
  "summary": "您希望为春季新款手袋策划营销活动，圈选中等消费偏好的人群，人数在2000以内，目标是提升转化率。"
}
================================================================================
```

**多轮融合报告**:
```
==================================================
Multi-turn Intent Merge Report:
  Previous business_goal: 提升春季新款手袋转化率
  New business_goal: 提升春季新款手袋转化率
  Previous constraints: []
  New constraints: []
  Previous kpi: conversion_rate
  New kpi: conversion_rate
==================================================
```

### 3. Ask Clarification Node 日志

**位置**: `backend/app/agent/nodes.py:239-258`

**日志格式**:
```
================================================================================
🤖 LLM CALL - Ask Clarification Node
================================================================================
--------------------------------------------------------------------------------
📝 PROMPT TO LLM:
你是一个营销专家助手。用户的描述不够清晰，你需要引导用户补充更多信息。

用户输入：...
当前识别的意图：{...}

请生成一个自然语言的反问，引导用户补充以下信息：
1. 业务目标是什么？
2. 想圈选哪类人群？
3. 有什么约束条件？
...
--------------------------------------------------------------------------------
📥 LLM RESPONSE:
我理解您想进行人群圈选。为了更精准地帮您，能否告诉我：您的核心目标是什么？比如是提升转化率、增加营收，还是促进到店？另外，您希望圈选哪类客户？比如VIP客户、年轻客户、高消费客户等？
================================================================================
```

### 4. Feature Matching Node 日志

**位置**: `backend/app/agent/nodes.py:331-349`

**日志格式**:
```
================================================================================
🤖 LLM CALL - Feature Matching Node
================================================================================
--------------------------------------------------------------------------------
📝 PROMPT TO LLM:
你是一个数据分析专家，负责将营销意图映射到具体的数据库特征。

用户意图：
{
  "business_goal": "提升转化率",
  "target_audience": {...},
  ...
}

可用特征列表：
[
  {"name": "r12m_spending", "type": "numeric", "description": "近12个月消费额"},
  {"name": "tier", "type": "categorical", "description": "会员等级"},
  ...
]

请将用户意图映射到特征，返回JSON...
--------------------------------------------------------------------------------
📥 LLM RESPONSE:
{
  "matched_features": [
    {
      "feature_name": "r12m_spending",
      "operator": ">=",
      "value": 10000,
      "description": "近12个月消费额大于1万"
    },
    {
      "feature_name": "tier",
      "operator": "in",
      "value": ["VIP", "VVIP"],
      "description": "会员等级为VIP或VVIP"
    }
  ],
  "is_success": true,
  "reason": ""
}
================================================================================
```

### 5. Request Modification Node 日志

**位置**: `backend/app/agent/nodes.py:439-458`

**日志格式**:
```
================================================================================
🤖 LLM CALL - Request Modification Node
================================================================================
--------------------------------------------------------------------------------
📝 PROMPT TO LLM:
你是一个营销专家助手。用户的圈人需求无法用现有的数据特征满足，你需要告知原因并引导修改。

用户意图：
{...}

已匹配的特征：
[...]

请生成一段自然、友好的引导语，说明：
1. 哪些需求无法满足，为什么
2. 建议用户如何调整需求
...
--------------------------------------------------------------------------------
📥 LLM RESPONSE:
抱歉，根据您的描述，我们暂时无法匹配到合适的数据特征。建议您：1) 简化一些条件，比如先不限制地域；2) 或者换个角度，比如关注用户的消费行为而不是兴趣标签。您可以重新描述一下需求吗？
================================================================================
```

### 6. Strategy Generation Node 日志

**位置**: `backend/app/agent/nodes.py:518-537`

**日志格式**:
```
================================================================================
🤖 LLM CALL - Strategy Generation Node
================================================================================
--------------------------------------------------------------------------------
📝 PROMPT TO LLM:
你是一个营销策略专家。根据用户意图和匹配的特征，生成一个圈选策略说明。

用户意图：
{
  "business_goal": "提升转化率",
  ...
}

匹配的特征：
[
  {"feature_name": "r12m_spending", "operator": ">=", "value": 10000, ...},
  ...
]

请用自然语言解释：
1. 我们将如何组合这些特征来圈选人群
2. 这个策略为什么能满足用户的业务目标
3. 预期能达到什么效果
...
--------------------------------------------------------------------------------
📥 LLM RESPONSE:
根据您的需求，我们将采用以下圈选策略：

**目标人群定位**：锁定VVIP和VIP客户，年龄在25-44岁之间，近12个月消费额超过10万元。

**行为筛选**：优先选择近30天浏览手袋品类超过10次、且有加购未下单记录的高意向用户。

**排除条件**：排除近7天已购买用户，避免营销疲劳。

**预期效果**：这一策略能够精准触达高价值、高意向的潜在客户，预计转化率可提升30-50%，同时避免对已转化用户的重复打扰。
================================================================================
```

### 7. Final Analysis Node 日志

**位置**: `backend/app/agent/nodes.py:695-714`

**日志格式**:
```
================================================================================
🤖 LLM CALL - Final Analysis Node
================================================================================
--------------------------------------------------------------------------------
📝 PROMPT TO LLM:
你是一个数据分析专家。根据圈人策略和预测结果，生成一份完整的分析报告。

策略说明：
根据您的需求，我们将采用以下圈选策略...

预测结果：
{
  "audience_size": 150,
  "conversion_rate": 0.05,
  "estimated_revenue": 135000,
  "roi": 4.5,
  ...
}

请生成一份专业的分析报告，包含：
1. **圈选结果概览**
2. **核心指标预测**
3. **Top用户预览**
4. **执行建议**
...
--------------------------------------------------------------------------------
📥 LLM RESPONSE:
# 圈选分析报告

## 圈选结果概览
成功圈选 150 位高价值用户，主要集中在 VIP 和 VVIP 等级...

## 核心指标预测
- **预估转化率**: 5.0%
- **预估收入**: ¥135,000
- **投资回报率**: 4.5倍
...

## Top 用户预览
1. 张三 - VVIP - 消费额: ¥85,000
2. 李四 - VIP - 消费额: ¥62,000
...

## 执行建议
建议在春季新品发布前7天启动营销活动...
================================================================================
```

## 日志级别

所有 LLM 调用日志都使用 `INFO` 级别，确保在默认配置下可见。

## 查看日志的方法

### 1. 实时查看后端日志

```bash
cd backend
python main.py
```

所有日志会直接输出到控制台。

### 2. 多轮对话测试场景

**第1轮输入**:
```
我想为春季新款手袋策划营销活动，2000人以内，提升转化率
```

**查看日志**:
1. `📚 CONVERSATION HISTORY` - 显示 "First turn - no history"
2. `🤖 LLM CALL - Intent Recognition Node` - 显示 "Multi-turn mode: False"
3. 提示词中没有 previous_intent
4. LLM 响应包含完整的 intent 结构

**第2轮输入**:
```
中等消费偏好的就可以
```

**查看日志**:
1. `📚 CONVERSATION HISTORY` - 显示完整的第1轮历史
2. `📌 Latest Intent` - 显示第1轮识别的意图
3. `📋 Accumulated Constraints` - 显示累积的约束条件
4. `📦 FINAL CONTEXT TO BE SENT TO LLM` - 显示构建的完整上下文
5. `🤖 LLM CALL - Intent Recognition Node` - 显示 "Multi-turn mode: True"
6. `Previous intent` - 显示第1轮的结构化意图作为基线
7. 提示词中明确指示 LLM 进行增量更新
8. `Multi-turn Intent Merge Report` - 对比前后意图的变化

## 日志分隔符说明

- `================================================================================` (80个=) - 主要部分分隔符
- `--------------------------------------------------------------------------------` (80个-) - 次要部分分隔符

## 日志图标说明

- 📚 - 对话历史
- 📜 - 历史摘要
- 📌 - 最新意图
- 📋 - 累积约束条件
- 📦 - 最终上下文
- 🤖 - LLM 调用
- 📝 - 发送的提示词
- 📥 - LLM 响应

## 关键日志检查点

### 验证多轮对话是否正常工作

1. **检查对话历史是否被记录**
   - 查找 `📚 CONVERSATION HISTORY`
   - 确认 `Total turns` 数量正确
   - 确认 `📜 History Summary` 包含所有轮次

2. **检查上一轮意图是否作为基线**
   - 查找 `Previous intent:` (在 Intent Recognition Node 中)
   - 确认其中包含上一轮的完整意图

3. **检查提示词是否包含融合指令**
   - 查找 `**多轮对话模式 - 重要**`
   - 确认提示词中包含 "以上一轮意图为基线"
   - 确认提示词中包含 "保留上一轮的值"

4. **检查 LLM 是否正确融合**
   - 查找 `Multi-turn Intent Merge Report`
   - 对比 `Previous business_goal` 和 `New business_goal`
   - 对比 `Previous constraints` 和 `New constraints`
   - 确认未提及的字段被保留

### 验证类型转换是否正常

1. **检查数值比较**
   - 查找 `Cannot compare` 警告日志
   - 如果出现，说明类型转换失败

2. **检查应用按钮点击**
   - 查找 `Calculating segmentation for proposal`
   - 查找 `Segmentation calculated: X users`
   - 不应该看到 `TypeError: '>' not supported`

## 修改的文件总结

1. **backend/app/core/session.py** (Line 178-260)
   - 添加对话历史构建日志
   - 打印历史摘要、最新意图、累积约束、最终上下文

2. **backend/app/agent/nodes.py**
   - Intent Recognition Node (Line 112-142)
   - Ask Clarification Node (Line 239-258)
   - Feature Matching Node (Line 331-349)
   - Request Modification Node (Line 439-458)
   - Strategy Generation Node (Line 518-537)
   - Final Analysis Node (Line 695-714)

## 日志文件大小注意事项

由于现在记录完整的提示词和响应，日志量会显著增加。建议：

1. **开发环境**: 保持当前配置，方便调试
2. **生产环境**: 考虑：
   - 将 LLM 日志级别设置为 DEBUG
   - 使用日志轮转（log rotation）
   - 定期清理旧日志

## 示例：完整的第2轮对话日志流程

```
1. 用户输入 "中等消费偏好的就可以"
   ↓
2. 📚 CONVERSATION HISTORY - 构建对话上下文
   - Session ID
   - Total turns: 1
   - 📜 History Summary: 第1轮完整信息
   - 📌 Latest Intent: 第1轮的结构化意图
   - 📋 Accumulated Constraints: []
   - 📦 FINAL CONTEXT: 包含历史和新输入的完整上下文
   ↓
3. 🤖 LLM CALL - Intent Recognition Node
   - Multi-turn mode: True
   - Previous intent: {...第1轮意图...}
   - 📝 PROMPT: 包含 previous_intent JSON + 融合指令
   - 📥 RESPONSE: 更新后的意图（保留了第1轮的 business_goal、kpi 等）
   - Multi-turn Intent Merge Report: 前后对比
   ↓
4. 🤖 LLM CALL - Feature Matching Node
   - 📝 PROMPT: 用户意图 + 可用特征
   - 📥 RESPONSE: 匹配的特征列表
   ↓
5. 🤖 LLM CALL - Strategy Generation Node
   - 📝 PROMPT: 用户意图 + 匹配特征
   - 📥 RESPONSE: 策略说明
   ↓
6. 🤖 LLM CALL - Final Analysis Node
   - 📝 PROMPT: 策略说明 + 预测结果
   - 📥 RESPONSE: 完整的分析报告
```

## 排查问题时的日志查找技巧

### 问题: 多轮对话没有融合历史信息

**查找步骤**:
1. 搜索 `Multi-turn mode:`
   - 如果是 `False`，说明没有检测到历史
   - 检查 session 是否正确保存

2. 搜索 `Previous intent:`
   - 如果为空或 None，说明上一轮意图没有传递
   - 检查 `session.current_context.get("latest_intent")`

3. 搜索 `Multi-turn Intent Merge Report`
   - 对比 `Previous` 和 `New` 字段
   - 如果 `New` 字段为空，说明 LLM 没有遵循融合指令

### 问题: 应用按钮点击报类型错误

**查找步骤**:
1. 搜索 `Calculating segmentation for proposal`
2. 查看下一行是否有 `ERROR: '>' not supported`
3. 搜索 `Cannot compare` 警告
   - 如果有，查看是哪个字段的比较失败

### 问题: LLM 响应格式错误

**查找步骤**:
1. 搜索对应节点的 `📥 LLM RESPONSE:`
2. 检查响应是否是有效的 JSON
3. 查找 `Failed to parse as JSON` 警告
4. 检查提示词中是否明确要求 JSON 格式
