# LangGraph å·¥ä½œæµé‡æ„å®ŒæˆæŒ‡å—

## ğŸ“‹ é‡æ„æ¦‚è§ˆ

æœ¬æ¬¡é‡æ„å°†åŸæœ‰çš„æµæ°´çº¿å¼å·¥ä½œæµæ”¹é€ ä¸º**å¤šè½®å¯¹è¯å¼å·¥ä½œæµ**ï¼Œæ”¯æŒæ„å›¾æ¾„æ¸…ã€ç‰¹å¾åŒ¹é…å’Œç­–ç•¥ç”Ÿæˆçš„å®Œæ•´æµç¨‹ã€‚

### æ ¸å¿ƒæ”¹è¿›

1. **å¤šè½®å¯¹è¯æ”¯æŒ** - æ”¯æŒæ¾„æ¸…é—®é¢˜ã€ä¿®æ­£å»ºè®®çš„äº¤äº’å¼å¯¹è¯
2. **æ¡ä»¶è·¯ç”±** - æ ¹æ®æ„å›¾æ˜ç¡®åº¦å’Œç‰¹å¾åŒ¹é…çŠ¶æ€åŠ¨æ€è·¯ç”±
3. **ç‰¹å¾å…ƒæ•°æ®åº“** - 45+ä¸ªå¥¢ä¾ˆå“ä¸šåŠ¡ç‰¹å¾ï¼ŒçœŸå®è´´è¿‘ä¸šåŠ¡åœºæ™¯
4. **æ›´æ¸…æ™°çš„çŠ¶æ€ç®¡ç†** - ä½¿ç”¨ MessagesState ç®¡ç†å¯¹è¯å†å²

---

## ğŸ—ï¸ æ–°æ¶æ„æ¦‚è§ˆ

### State Schema (backend/app/agent/state.py)

```python
class AgentState(MessagesState):
    # ç”¨æˆ·è¾“å…¥
    user_input: str

    # æ„å›¾è¯†åˆ«
    user_intent: UserIntent
    intent_status: "ambiguous" | "clear"

    # ç‰¹å¾åŒ¹é…
    matched_features: list[MatchedFeature]
    match_status: "success" | "needs_refinement"

    # ç­–ç•¥ç”Ÿæˆ
    strategy_explanation: str

    # æ•ˆæœé¢„æµ‹
    prediction_result: PredictionResult

    # æœ€ç»ˆè¾“å‡º
    final_response: str
```

### å·¥ä½œæµç¨‹å›¾

```
Start
  â†“
intent_recognition (æ„å›¾è¯†åˆ«)
  â†“
[æ¡ä»¶è·¯ç”±1]
  â”œâ”€ ambiguous â†’ ask_clarification â†’ END (è¿”å›æ¾„æ¸…é—®é¢˜)
  â””â”€ clear â†’ feature_matching (ç‰¹å¾åŒ¹é…)
                â†“
            [æ¡ä»¶è·¯ç”±2]
              â”œâ”€ needs_refinement â†’ request_modification â†’ END (è¿”å›ä¿®æ­£å»ºè®®)
              â””â”€ success â†’ strategy_generation (ç­–ç•¥ç”Ÿæˆ)
                            â†“
                        impact_prediction (æ•ˆæœé¢„æµ‹)
                            â†“
                        final_analysis (ç»“æœè¾“å‡º)
                            â†“
                           END
```

### 7ä¸ªæ ¸å¿ƒèŠ‚ç‚¹

| èŠ‚ç‚¹ | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º |
|-----|------|------|------|
| A. intent_recognition | æ„å›¾è¯†åˆ« | user_input, messages | user_intent, intent_status |
| B. ask_clarification | æ¾„æ¸…é—®é¢˜ | user_input, user_intent | clarification_question |
| C. feature_matching | ç‰¹å¾åŒ¹é… | user_intent | matched_features, match_status |
| D. request_modification | ä¿®æ­£å»ºè®® | user_intent, matched_features | modification_request |
| E. strategy_generation | ç­–ç•¥ç”Ÿæˆ | user_intent, matched_features | strategy_explanation |
| F. impact_prediction | æ•ˆæœé¢„æµ‹ | matched_features | prediction_result |
| G. final_analysis | ç»“æœè¾“å‡º | prediction_result, strategy_explanation | final_response |

---

## ğŸ—‚ï¸ æ–‡ä»¶ç»“æ„

### æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”œâ”€â”€ state.py           (é‡æ„) - æ–°çš„ State Schema
â”‚   â”‚   â”œâ”€â”€ nodes.py           (é‡æ„) - 7ä¸ªæ–°èŠ‚ç‚¹
â”‚   â”‚   â”œâ”€â”€ graph.py           (é‡æ„) - æ¡ä»¶è·¯ç”±é€»è¾‘
â”‚   â”‚
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ feature_metadata.py (æ–°å¢) - ç‰¹å¾å…ƒæ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ mock_users.py      (æ‰©å±•) - æ‰©å±•ç”¨æˆ·ç‰¹å¾
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ schemas.py         (æ‰©å±•) - æ–°å¢ V2 schemas
â”‚   â”‚   â”œâ”€â”€ routes.py          (æ‰©å±•) - æ–°å¢ /analysis/v2 endpoint
â”‚   â”‚
â”œâ”€â”€ test_workflow_v2.py        (æ–°å¢) - å·¥ä½œæµæµ‹è¯•è„šæœ¬
â”œâ”€â”€ test_api_v2.py             (æ–°å¢) - API æµ‹è¯•è„šæœ¬
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æµ‹è¯•å·¥ä½œæµï¼ˆæ— éœ€å¯åŠ¨æœåŠ¡å™¨ï¼‰

```bash
cd backend
python test_workflow_v2.py
```

**æµ‹è¯•åœºæ™¯ï¼š**
- âœ… æ˜ç¡®æ„å›¾ - ç›´æ¥å®Œæˆåˆ†æ
- âœ… æ¨¡ç³Šæ„å›¾ - è¿”å›æ¾„æ¸…é—®é¢˜
- âœ… å¤šè½®å¯¹è¯ - æ„å›¾è¡¥å……å’Œå®Œå–„
- âœ… ç‰¹å¾åŒ¹é… - å¤æ‚æ¡ä»¶æ˜ å°„

### 2. æµ‹è¯• API Endpoint

**å¯åŠ¨æœåŠ¡å™¨ï¼š**
```bash
cd backend
uvicorn app.main:app --reload
```

**è¿è¡Œ API æµ‹è¯•ï¼š**
```bash
cd backend
python test_api_v2.py
```

### 3. ä½¿ç”¨ V2 API

**Endpoint:** `POST /api/v1/analysis/v2`

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "prompt": "æˆ‘è¦ä¸ºæ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ä¸Šå¸‚åšä¸€æ¬¡æ¨å¹¿ï¼Œç›®æ ‡æ˜¯æå‡è½¬åŒ–ç‡ã€‚åœˆé€‰VVIPå’ŒVIPå®¢æˆ·ã€‚",
  "session_id": null,
  "stream": false
}
```

**å“åº”æ ¼å¼ï¼š**
```json
{
  "session_id": "abc123...",
  "status": "success" | "clarification_needed" | "modification_needed",
  "response": "è‡ªç„¶è¯­è¨€å›å¤...",

  // å½“ status == "success" æ—¶æœ‰å€¼
  "user_intent": {...},
  "matched_features": [...],
  "strategy_explanation": "...",
  "prediction_result": {
    "audience_size": 100,
    "conversion_rate": 0.08,
    "estimated_revenue": 144000,
    "roi": 5.0,
    ...
  }
}
```

---

## ğŸ“Š ç‰¹å¾å…ƒæ•°æ®åº“

### ç‰¹å¾åˆ†ç±»ï¼ˆ12å¤§ç±»ï¼‰

1. **äººå£å±æ€§** - æ€§åˆ«ã€å¹´é¾„ã€åŸå¸‚ã€èŒä¸š
2. **ä¼šå‘˜ç­‰çº§** - VVIPã€VIPã€Member
3. **æ¶ˆè´¹åŠ›æŒ‡æ ‡** - å¹´æ¶ˆè´¹é¢ã€å®¢å•ä»·ã€è´­ä¹°é¢‘æ¬¡ã€æµ·å¤–æ¶ˆè´¹
4. **å“ç‰Œå¿ è¯šåº¦** - å¿ è¯šåº¦åˆ†æ•°ã€æ¬¾å¼åå¥½
5. **å“ç±»å…´è¶£** - æ‰‹è¢‹æµè§ˆã€ç å®æµè§ˆã€åŠ è´­æœªæ”¯ä»˜
6. **å“ç‰Œæ´»è·ƒåº¦** - é—¨åº—åˆ°è®¿ã€çº¿ä¸Šæ´»è·ƒã€é‚®ä»¶æ‰“å¼€ç‡
7. **ä¼šå‘˜æƒç›Šä½¿ç”¨** - VIPä¼‘æ¯å®¤ã€ç§äººé¡¾é—®
8. **æ•°å­—è¡Œä¸º** - APPæ´»è·ƒã€å¾®ä¿¡äº’åŠ¨ã€ç›´æ’­å‚ä¸
9. **è¥é”€å“åº”** - é‚®ä»¶ç‚¹å‡»ã€æ¨èå¥½å‹ã€ç¤¾äº¤äº’åŠ¨
10. **ç”Ÿå‘½å‘¨æœŸ** - ä¼šå‘˜å¤©æ•°ã€é¦–è´­å¤©æ•°
11. **é£æ§ä¸æ’é™¤** - æŠ•è¯‰æ•°ã€é€€è´§ç‡
12. **è¥é”€ç–²åŠ³åº¦** - è§¦è¾¾å¤©æ•°ã€è§¦è¾¾æ¬¡æ•°

### ç¤ºä¾‹ç‰¹å¾

```python
"r12m_spending": {
    "name": "r12m_spending",
    "display_name": "è¿‘12ä¸ªæœˆæ¶ˆè´¹é¢",
    "type": "numeric",
    "category": "æ¶ˆè´¹åŠ›æŒ‡æ ‡",
    "description": "å®¢æˆ·è¿‘12ä¸ªæœˆç´¯è®¡æ¶ˆè´¹é‡‘é¢ï¼ˆäººæ°‘å¸ï¼‰",
    "examples": ["æ¶ˆè´¹é¢å¤§äº10ä¸‡", "å¹´åº¦æ¶ˆè´¹è¶…è¿‡50ä¸‡"],
    "valid_operators": [">", ">=", "<", "<=", "==", "between"],
}
```

---

## ğŸ”„ å¤šè½®å¯¹è¯ç¤ºä¾‹

### åœºæ™¯1ï¼šæ„å›¾æ¾„æ¸…

**ç”¨æˆ·:** å¸®æˆ‘åœˆé€‰ä¸€äº›ç”¨æˆ·

**Agent:** æˆ‘ç†è§£æ‚¨æƒ³è¿›è¡Œäººç¾¤åœˆé€‰ã€‚ä¸ºäº†æ›´ç²¾å‡†åœ°å¸®æ‚¨ï¼Œèƒ½å¦å‘Šè¯‰æˆ‘ï¼š
1. æ‚¨çš„æ ¸å¿ƒç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæå‡è½¬åŒ–ç‡ã€å¢åŠ è¥æ”¶ã€ä¿ƒè¿›åˆ°åº—ï¼Ÿï¼‰
2. æ‚¨å¸Œæœ›åœˆé€‰å“ªç±»å®¢æˆ·ï¼Ÿï¼ˆVIPå®¢æˆ·ã€å¹´è½»å®¢æˆ·ã€é«˜æ¶ˆè´¹å®¢æˆ·ï¼Ÿï¼‰
3. æœ‰ä»€ä¹ˆçº¦æŸæ¡ä»¶å—ï¼Ÿï¼ˆäººç¾¤è§„æ¨¡ã€é¢„ç®—ã€æ’é™¤æ¡ä»¶ï¼Ÿï¼‰

**ç”¨æˆ·:** ç›®æ ‡æ˜¯æå‡æ‰‹è¢‹è½¬åŒ–ç‡ï¼Œåœˆé€‰VIPå®¢æˆ·

**Agent:** âœ… [æ‰§è¡Œå®Œæ•´åˆ†æï¼Œè¿”å›ç»“æœ]

### åœºæ™¯2ï¼šç‰¹å¾æ— æ³•åŒ¹é…

**ç”¨æˆ·:** åœˆé€‰å–œæ¬¢çº¢è‰²æ‰‹è¢‹çš„ç”¨æˆ·

**Agent:** æŠ±æ­‰ï¼Œæˆ‘ä»¬å½“å‰çš„æ•°æ®ç‰¹å¾æš‚æ—¶æ— æ³•æ”¯æŒ"é¢œè‰²åå¥½"è¿™ä¸€ç»´åº¦ã€‚å»ºè®®æ‚¨ï¼š
1. æ¢ä¸ªè§’åº¦ï¼Œå…³æ³¨ç”¨æˆ·çš„å“ç±»å…´è¶£ï¼ˆå¦‚"æµè§ˆæ‰‹è¢‹è¶…è¿‡10æ¬¡"ï¼‰
2. æˆ–è€…å…³æ³¨æ¶ˆè´¹è¡Œä¸ºï¼ˆå¦‚"æœ€è¿‘è´­ä¹°è¿‡æ‰‹è¢‹"ï¼‰

æ‚¨å¯ä»¥é‡æ–°æè¿°ä¸€ä¸‹éœ€æ±‚å—ï¼Ÿ

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

æµ‹è¯•æ¯ä¸ªèŠ‚ç‚¹çš„ç‹¬ç«‹åŠŸèƒ½ï¼š
```python
from app.agent.nodes import intent_recognition_node

state = {"user_input": "åœˆé€‰VIPå®¢æˆ·"}
result = await intent_recognition_node(state)
assert result["intent_status"] in ["clear", "ambiguous"]
```

### 2. é›†æˆæµ‹è¯•

æµ‹è¯•å®Œæ•´å·¥ä½œæµï¼š
```bash
python backend/test_workflow_v2.py
```

### 3. API æµ‹è¯•

æµ‹è¯•HTTPæ¥å£ï¼š
```bash
python backend/test_api_v2.py
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. LLM ä¾èµ–

æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¾èµ– LLM è°ƒç”¨ã€‚ç¡®ä¿ï¼š
- `app.models.llm.get_llm_manager()` å¯ç”¨
- LLM æ”¯æŒè¿”å› JSON å’Œçº¯æ–‡æœ¬
- API Key å·²é…ç½®

### 2. å‘åå…¼å®¹

æ—§çš„ `/api/v1/analysis` endpoint ä»ç„¶ä¿ç•™ï¼Œæ–° endpoint ä¸º `/api/v1/analysis/v2`ã€‚

### 3. Session ç®¡ç†

- V2 ä½¿ç”¨ `messages` å­—æ®µå­˜å‚¨å¯¹è¯å†å²
- Session ID è‡ªåŠ¨ç”Ÿæˆæˆ–ç”±å®¢æˆ·ç«¯æä¾›
- å¤šè½®å¯¹è¯ä¾èµ– Session æŒä¹…åŒ–

### 4. Mock æ•°æ®

å½“å‰ `impact_prediction_node` ä½¿ç”¨ mock æ•°æ®ã€‚ç”Ÿäº§ç¯å¢ƒéœ€æ›¿æ¢ä¸ºçœŸå®æ•°æ®æŸ¥è¯¢å·¥å…·ã€‚

---

## ğŸ”§ ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. âœ… **æµå¼è¾“å‡º** - ~~æ”¯æŒç­–ç•¥ç”Ÿæˆå’Œåˆ†ææŠ¥å‘Šçš„æµå¼è¾“å‡º~~ **å·²å®Œæˆï¼** è§ `STREAMING_GUIDE.md`
2. **å·¥å…·é›†æˆ** - å°† impact_prediction èŠ‚ç‚¹æ¥å…¥çœŸå®æ•°æ®åº“
3. **ç¼“å­˜ä¼˜åŒ–** - ç¼“å­˜ç‰¹å¾å…ƒæ•°æ®å’Œç”¨æˆ·æ•°æ®
4. **é”™è¯¯å¤„ç†** - å¢å¼ºå¼‚å¸¸å¤„ç†å’Œé™çº§ç­–ç•¥
5. **å‰ç«¯é€‚é…** - æ›´æ–°å‰ç«¯ä»¥æ”¯æŒ V2 API çš„å¤šè½®å¯¹è¯å’Œæµå¼æ¨ç†å±•ç¤º

---

## ğŸŒŸ æœ€æ–°æ›´æ–°ï¼šæµå¼æ¨ç†è¾“å‡ºï¼ˆ2026-01-17ï¼‰

### V2.1 - æµå¼æ¨ç†è¾“å‡º

å·²å®ç° **LLM é€æ­¥æ¨ç†æµå¼è¾“å‡º** åŠŸèƒ½ï¼

**æ–°å¢æ–‡ä»¶ï¼š**
- `backend/app/agent/streaming_nodes.py` - æµå¼èŠ‚ç‚¹ï¼ˆå¸¦ Chain-of-Thought æ¨ç†ï¼‰
- `backend/test_streaming_v2.py` - æµå¼ endpoint æµ‹è¯•è„šæœ¬
- `STREAMING_GUIDE.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—

**æ–°å¢ Endpointï¼š**
- `GET /api/v1/analysis/v2/stream` - V2 æµå¼åˆ†æ endpoint

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- âœ… Chain-of-Thought (CoT) æ¨ç† - LLM å…ˆè¾“å‡ºæ¨ç†æ­¥éª¤å†ç»™å‡ºç»“æœ
- âœ… å®æ—¶æµå¼ä¼ è¾“ - æ¨ç†è¿‡ç¨‹é€å­—ä¼ è¾“åˆ°å‰ç«¯ï¼ˆSSEï¼‰
- âœ… èŠ‚ç‚¹çº§æµå¼æ§åˆ¶ - å…³é”®èŠ‚ç‚¹æµå¼ï¼Œè®¡ç®—èŠ‚ç‚¹å¿«é€Ÿå“åº”
- âœ… å¤šè½®å¯¹è¯æ”¯æŒ - é€šè¿‡ session_id ä¿æŒä¸Šä¸‹æ–‡

### V2.2 - èŠ‚ç‚¹è‡ªç„¶è¯­è¨€è¾“å‡ºå¢å¼º â­ æ–°å¢

å·²ä¸ºæ¯ä¸ªå…³é”®èŠ‚ç‚¹æ·»åŠ  **è‡ªç„¶è¯­è¨€æè¿°è¾“å‡º**ï¼Œæå‡å¯è§£é‡Šæ€§å’Œå®¢æˆ·ä½“éªŒï¼

**æ”¹è¿›å†…å®¹ï¼š**
- âœ… **intent_recognition** - è¿”å›æ„å›¾ç†è§£æ‘˜è¦ï¼š"æ‚¨å¸Œæœ›é’ˆå¯¹æ˜¥å­£æ–°å“æ‰‹è¢‹ä¸Šå¸‚ï¼Œåœˆé€‰25-44å²çš„VVIPå’ŒVIPå®¢æˆ·..."
- âœ… **feature_matching** - è¿”å›ç‰¹å¾åŒ¹é…æ‘˜è¦ + ç‰¹å¾åˆ—è¡¨
- âœ… **strategy_generation** - è¿”å›ç­–ç•¥æ‘˜è¦ + è¯¦ç»†è¯´æ˜
- âœ… **final_analysis** - è¿”å›æ‰§è¡Œæ‘˜è¦ + å®Œæ•´æŠ¥å‘Š

**æ–°å¢å­—æ®µï¼š**
æ¯ä¸ª `node_complete` äº‹ä»¶ç°åœ¨åŒ…å«ï¼š
- `summary` / `strategy_summary` / `executive_summary` - ç®€æ´æ‘˜è¦
- `display_text` - æ ¼å¼åŒ–çš„å‰ç«¯æ˜¾ç¤ºæ–‡æœ¬
- åŸæœ‰çš„ç»“æ„åŒ–æ•°æ®ä¿æŒä¸å˜ï¼ˆå‘åå…¼å®¹ï¼‰

**å‰ç«¯æ˜¾ç¤ºç¤ºä¾‹ï¼š**
```
âœ“ æ„å›¾è¯†åˆ«å®Œæˆ

æ‚¨å¸Œæœ›é’ˆå¯¹æ˜¥å­£æ–°å“æ‰‹è¢‹ä¸Šå¸‚ï¼Œåœˆé€‰25-44å²çš„VVIPå’ŒVIPå®¢æˆ·ï¼Œä»¥æå‡äº§å“è½¬åŒ–ç‡ã€‚

---

âœ“ ç‰¹å¾åŒ¹é…å®Œæˆ

å·²ä¸ºæ‚¨åŒ¹é…4ä¸ªå…³é”®ç‰¹å¾ï¼šä¼šå‘˜ç­‰çº§ï¼ˆVVIP/VIPï¼‰ã€å¹´é¾„æ®µï¼ˆ25-44å²ï¼‰ã€æ‰‹è¢‹æµè§ˆå…´è¶£ã€é«˜æ¶ˆè´¹åŠ›ï¼ˆå¹´æ¶ˆè´¹>5ä¸‡ï¼‰ã€‚

åŒ¹é…çš„ç‰¹å¾ï¼š
1. ä¼šå‘˜ç­‰çº§ä¸ºVVIPæˆ–VIP
2. å¹´é¾„æ®µåœ¨25-44å²
...
```

**è¯¦ç»†æ–‡æ¡£ï¼š**
å®Œæ•´è¯´æ˜å’Œå‰ç«¯é›†æˆæŒ‡å—è¯·æŸ¥çœ‹ `NODE_OUTPUT_ENHANCEMENT.md`

**å¿«é€Ÿæµ‹è¯•ï¼š**
```bash
# å¯åŠ¨æœåŠ¡å™¨
cd backend && uvicorn app.main:app --reload

# è¿è¡Œæµ‹è¯•ï¼ˆæ–°çª—å£ï¼‰
cd backend && python test_streaming_v2.py
```

**è¯¦ç»†æ–‡æ¡£ï¼š**
å®Œæ•´ä½¿ç”¨æŒ‡å—å’Œç¤ºä¾‹è¯·æŸ¥çœ‹ `STREAMING_GUIDE.md`

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- ä»£ç æ–‡æ¡£ï¼š`backend/app/agent/`
- V2 å·¥ä½œæµæµ‹è¯•ï¼š`backend/test_workflow_v2.py`
- V2 API æµ‹è¯•ï¼š`backend/test_api_v2.py`
- **V2 æµå¼æµ‹è¯•**ï¼š`backend/test_streaming_v2.py` â­
- **æµå¼æ¨ç†æŒ‡å—**ï¼š`STREAMING_GUIDE.md` â­
- **èŠ‚ç‚¹è¾“å‡ºå¢å¼º**ï¼š`NODE_OUTPUT_ENHANCEMENT.md` â­ æ–°å¢
- API æ–‡æ¡£ï¼šå¯åŠ¨æœåŠ¡å™¨åè®¿é—® `http://localhost:8000/docs`

---

**é‡æ„å®Œæˆæ—¶é—´:** 2026-01-17
**ç‰ˆæœ¬:** V2.2 - Natural Language Output Enhancement
