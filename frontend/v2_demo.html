<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V2 æµå¼åˆ†æ - å®æ—¶æ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 14px;
      opacity: 0.9;
    }

    .content {
      padding: 30px;
    }

    .input-section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    textarea {
      width: 100%;
      height: 100px;
      padding: 12px;
      font-size: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #results {
      margin-top: 30px;
    }

    .node {
      margin-bottom: 20px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.3s;
      background: white;
    }

    .node.running {
      border-color: #4CAF50;
      background: linear-gradient(to right, #f1f8f4 0%, white 100%);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
    }

    .node.completed {
      border-color: #2196F3;
      background: linear-gradient(to right, #e3f2fd 0%, white 100%);
    }

    .node-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #ccc;
    }

    .running .status-indicator {
      background-color: #4CAF50;
      animation: pulse 1.5s infinite;
    }

    .completed .status-indicator {
      background-color: #2196F3;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.6;
        transform: scale(1.1);
      }
    }

    .node-result {
      margin-top: 15px;
      white-space: pre-wrap;
      line-height: 1.8;
      color: #333;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .reasoning {
      background-color: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
      max-height: 250px;
      overflow-y: auto;
      margin-top: 10px;
      color: #555;
      line-height: 1.6;
    }

    details {
      margin-top: 12px;
      cursor: pointer;
    }

    summary {
      color: #666;
      font-size: 13px;
      font-weight: 500;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    summary:hover {
      background-color: #f5f5f5;
    }

    .final-result {
      margin-top: 30px;
      padding: 25px;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-radius: 10px;
      border-left: 5px solid #4CAF50;
    }

    .final-result h2 {
      color: #2e7d32;
      margin-bottom: 15px;
      font-size: 20px;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .metric-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #2e7d32;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 5px solid #c62828;
    }

    .info-banner {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #2196F3;
    }

    .info-banner strong {
      color: #1976d2;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸš€ V2 æµå¼åˆ†ææ¼”ç¤º</h1>
      <p class="subtitle">å®æ—¶æŸ¥çœ‹ LLM æ¨ç†è¿‡ç¨‹å’Œè‡ªç„¶è¯­è¨€è¾“å‡º</p>
    </header>

    <div class="content">
      <div class="info-banner">
        <strong>ğŸ’¡ æç¤ºï¼š</strong> è¿™æ˜¯ V2 æµå¼ endpoint çš„å®æ—¶æ¼”ç¤ºã€‚è¾“å…¥æ‚¨çš„éœ€æ±‚ï¼Œç«‹å³çœ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œç»“æœå’Œ LLM æ¨ç†è¿‡ç¨‹ã€‚
      </div>

      <div class="input-section">
        <label for="promptInput">è¾“å…¥æ‚¨çš„åœˆäººéœ€æ±‚ï¼š</label>
        <textarea id="promptInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘è¦ä¸ºæ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ä¸Šå¸‚åšæ¨å¹¿ï¼Œåœˆé€‰VVIPå’ŒVIPå®¢æˆ·ï¼Œå¹´é¾„åœ¨25-44å²">æˆ‘è¦ä¸ºæ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ä¸Šå¸‚åšæ¨å¹¿ï¼Œåœˆé€‰VVIPå’ŒVIPå®¢æˆ·</textarea>

        <div class="button-group">
          <button class="btn-primary" onclick="startAnalysis()" id="startBtn">
            å¼€å§‹åˆ†æ
          </button>
          <button class="btn-secondary" onclick="clearResults()" id="clearBtn">
            æ¸…ç©ºç»“æœ
          </button>
        </div>
      </div>

      <div id="results"></div>
    </div>
  </div>

  <script>
    let eventSource = null;
    const nodes = {};

    function startAnalysis() {
      const prompt = document.getElementById('promptInput').value.trim();
      if (!prompt) {
        alert('è¯·è¾“å…¥åˆ†æéœ€æ±‚');
        return;
      }

      // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
      clearResults();

      // ç¦ç”¨æŒ‰é’®
      document.getElementById('startBtn').disabled = true;
      document.getElementById('startBtn').innerHTML = 'åˆ†æä¸­... <span class="spinner"></span>';

      // å…³é—­ä¹‹å‰çš„è¿æ¥
      if (eventSource) {
        eventSource.close();
      }

      // åˆ›å»º SSE è¿æ¥
      const url = `/api/v1/analysis/v2/stream?prompt=${encodeURIComponent(prompt)}`;
      console.log('è¿æ¥åˆ°:', url);

      eventSource = new EventSource(url);

      eventSource.addEventListener('message', (e) => {
        try {
          const event = JSON.parse(e.data);
          console.log('æ”¶åˆ°äº‹ä»¶:', event.type, event);

          switch (event.type) {
            case 'node_start':
              createNodeElement(event.node, event.title);
              updateNodeStatus(event.node, 'running');
              break;

            case 'reasoning':
              appendReasoning(event.node, event.data);
              break;

            case 'node_complete':
              updateNodeStatus(event.node, 'completed');
              if (event.data.display_text) {
                showNodeResult(event.node, event.data.display_text);
              }
              break;

            case 'workflow_complete':
              showFinalResult(event.data);
              finishAnalysis();
              break;

            case 'error':
              showError(event.data);
              finishAnalysis();
              break;
          }
        } catch (error) {
          console.error('å¤„ç†äº‹ä»¶å¤±è´¥:', error);
        }
      });

      eventSource.onerror = (error) => {
        console.error('SSE è¿æ¥é”™è¯¯:', error);
        showError('è¿æ¥åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ');
        finishAnalysis();
      };
    }

    function finishAnalysis() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = 'å¼€å§‹åˆ†æ';
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      Object.keys(nodes).forEach(key => delete nodes[key]);
    }

    function createNodeElement(nodeId, title) {
      const nodeDiv = document.createElement('div');
      nodeDiv.id = `node-${nodeId}`;
      nodeDiv.className = 'node';
      nodeDiv.innerHTML = `
        <div class="node-title">
          <span class="status-indicator"></span>
          <span>${title}</span>
        </div>
        <div class="node-result" id="result-${nodeId}" style="display:none;"></div>
        <details id="reasoning-container-${nodeId}" style="display:none;">
          <summary>ğŸ” æŸ¥çœ‹ LLM æ¨ç†è¿‡ç¨‹</summary>
          <pre class="reasoning" id="reasoning-${nodeId}"></pre>
        </details>
      `;
      document.getElementById('results').appendChild(nodeDiv);
      nodes[nodeId] = { element: nodeDiv };
    }

    function updateNodeStatus(nodeId, status) {
      const nodeElement = document.getElementById(`node-${nodeId}`);
      if (nodeElement) {
        nodeElement.className = `node ${status}`;
      }
    }

    function appendReasoning(nodeId, text) {
      const reasoningElement = document.getElementById(`reasoning-${nodeId}`);
      const containerElement = document.getElementById(`reasoning-container-${nodeId}`);

      if (reasoningElement && containerElement) {
        reasoningElement.textContent += text;
        containerElement.style.display = 'block';

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        reasoningElement.scrollTop = reasoningElement.scrollHeight;
      }
    }

    function showNodeResult(nodeId, displayText) {
      const resultElement = document.getElementById(`result-${nodeId}`);
      if (resultElement) {
        resultElement.style.display = 'block';
        resultElement.textContent = displayText;
      }
    }

    function showFinalResult(data) {
      const finalDiv = document.createElement('div');
      finalDiv.className = 'final-result';

      let html = '<h2>âœ“ åˆ†æå®Œæˆ</h2>';

      if (data.prediction_result) {
        const pr = data.prediction_result;
        html += '<div class="metrics">';
        html += `
          <div class="metric-card">
            <div class="metric-label">åœˆé€‰äººæ•°</div>
            <div class="metric-value">${pr.audience_size}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">é¢„ä¼°è½¬åŒ–ç‡</div>
            <div class="metric-value">${(pr.conversion_rate * 100).toFixed(2)}%</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">é¢„ä¼°æ”¶å…¥</div>
            <div class="metric-value">Â¥${pr.estimated_revenue.toLocaleString()}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">ROI</div>
            <div class="metric-value">${pr.roi.toFixed(2)}x</div>
          </div>
        `;
        html += '</div>';
      }

      finalDiv.innerHTML = html;
      document.getElementById('results').appendChild(finalDiv);
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = 'âŒ é”™è¯¯: ' + message;
      document.getElementById('results').appendChild(errorDiv);
    }
  </script>
</body>
</html>
