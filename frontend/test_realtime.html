<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®æ—¶æµå¼æµ‹è¯•</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }

    h1 {
      color: #4ec9b0;
      text-align: center;
    }

    .input-section {
      margin: 20px 0;
      padding: 15px;
      background: #252526;
      border-radius: 8px;
    }

    textarea {
      width: 100%;
      height: 60px;
      padding: 10px;
      background: #1e1e1e;
      color: #d4d4d4;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      font-family: inherit;
    }

    button {
      padding: 10px 20px;
      margin-top: 10px;
      background: #0e639c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #1177bb;
    }

    button:disabled {
      background: #3c3c3c;
      cursor: not-allowed;
    }

    #log {
      margin-top: 20px;
      padding: 15px;
      background: #252526;
      border-radius: 8px;
      max-height: 600px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry {
      margin: 5px 0;
      padding: 5px 10px;
      border-left: 3px solid transparent;
    }

    .log-time {
      color: #858585;
      margin-right: 10px;
    }

    .log-connect { color: #4ec9b0; border-color: #4ec9b0; }
    .log-node-complete { color: #dcdcaa; border-color: #dcdcaa; font-weight: bold; }
    .log-node-summary { color: #569cd6; border-color: #569cd6; }
    .log-step-update { color: #ce9178; border-color: #ce9178; }
    .log-final { color: #4ec9b0; border-color: #4ec9b0; font-weight: bold; }
    .log-error { color: #f48771; border-color: #f48771; }

    .stats {
      margin-top: 20px;
      padding: 15px;
      background: #264f78;
      border-radius: 8px;
      color: white;
    }

    .stats strong {
      color: #4ec9b0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” å®æ—¶æµå¼è¾“å‡ºæµ‹è¯•</h1>

  <div class="input-section">
    <textarea id="promptInput" placeholder="è¾“å…¥æµ‹è¯•æç¤ºè¯...">æˆ‘è¦æå‡ä¸‹å•æ•´ä½“è½¬åŒ–ç‡</textarea>
    <button id="startBtn" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
    <button id="stopBtn" onclick="stopTest()" disabled>åœæ­¢</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <div class="stats" id="stats" style="display: none;">
    <div>æ€»è€—æ—¶: <strong id="totalTime">0</strong> ç§’</div>
    <div>äº‹ä»¶æ€»æ•°: <strong id="eventCount">0</strong></div>
    <div>èŠ‚ç‚¹å®Œæˆ: <strong id="nodeCompleteCount">0</strong> ä¸ª</div>
  </div>

  <div id="log"></div>

  <script>
    let eventSource = null;
    let startTime = null;
    let lastEventTime = null;
    let eventCount = 0;
    let nodeCompleteCount = 0;

    function getTimestamp() {
      const now = new Date();
      return now.toTimeString().split(' ')[0] + '.' + now.getMilliseconds().toString().padStart(3, '0');
    }

    function getInterval() {
      if (!lastEventTime) {
        return '(é¦–ä¸ªäº‹ä»¶)';
      }
      const now = new Date();
      const diff = (now - lastEventTime) / 1000;
      return `(+${diff.toFixed(2)}s)`;
    }

    function log(message, className = '') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + className;

      const timestamp = getTimestamp();
      const interval = getInterval();

      entry.innerHTML = `<span class="log-time">[${timestamp}] ${interval}</span>${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;

      lastEventTime = new Date();
      eventCount++;
      updateStats();
    }

    function updateStats() {
      if (!startTime) return;

      const totalTime = ((new Date() - startTime) / 1000).toFixed(2);
      document.getElementById('totalTime').textContent = totalTime;
      document.getElementById('eventCount').textContent = eventCount;
      document.getElementById('nodeCompleteCount').textContent = nodeCompleteCount;
      document.getElementById('stats').style.display = 'block';
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      eventCount = 0;
      nodeCompleteCount = 0;
      startTime = null;
      lastEventTime = null;
      document.getElementById('stats').style.display = 'none';
    }

    function startTest() {
      const prompt = document.getElementById('promptInput').value.trim();
      if (!prompt) {
        alert('è¯·è¾“å…¥æç¤ºè¯');
        return;
      }

      clearLog();
      startTime = new Date();
      lastEventTime = startTime;

      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;

      const url = `/api/v1/analysis/stream?prompt=${encodeURIComponent(prompt)}`;

      log(`ğŸ”— è¿æ¥åˆ°: ${url}`, 'log-connect');

      eventSource = new EventSource(url);

      eventSource.addEventListener('thinking_step', (e) => {
        const data = JSON.parse(e.data);
        log(`ğŸ“‹ thinking_step: ${data.title} (status: ${data.status})`, 'log-step-update');
      });

      eventSource.addEventListener('thinking_step_update', (e) => {
        const data = JSON.parse(e.data);
        log(`âœ… thinking_step_update: ${data.title}`, 'log-step-update');
      });

      eventSource.addEventListener('node_summary', (e) => {
        const data = JSON.parse(e.data);
        const summaryPreview = data.summary.substring(0, 80).replace(/\n/g, ' ');
        log(`ğŸ“ node_summary [${data.node}]: ${summaryPreview}...`, 'log-node-summary');
      });

      // ğŸ”¥ ç›‘å¬æ–°å¢çš„ node_complete äº‹ä»¶
      eventSource.addEventListener('node_complete', (e) => {
        const data = JSON.parse(e.data);
        nodeCompleteCount++;
        log(`ğŸ‰ NODE_COMPLETE [${data.node}] - èŠ‚ç‚¹å®Œæˆï¼`, 'log-node-complete');
      });

      eventSource.addEventListener('final_result', (e) => {
        log(`ğŸ final_result: åˆ†æå®Œæˆ`, 'log-final');
        stopTest();
      });

      eventSource.onerror = (error) => {
        log(`âŒ è¿æ¥é”™è¯¯: ${error.type}`, 'log-error');
        stopTest();
      };
    }

    function stopTest() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      log('ğŸ›‘ æµ‹è¯•ç»“æŸ', 'log-final');
    }
  </script>
</body>
</html>
