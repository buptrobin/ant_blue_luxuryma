# å¤šè½®å¯¹è¯ä¿¡æ¯èåˆä¿®å¤

## é—®é¢˜æè¿°

åœ¨å¤šè½®å¯¹è¯åœºæ™¯ä¸­ï¼Œå½“ç”¨æˆ·æä¾›è¡¥å……ä¿¡æ¯æ—¶ï¼ˆå¦‚ç¬¬äºŒè½®è¾“å…¥"ä¸­ç­‰æ¶ˆè´¹åå¥½çš„å°±å¯ä»¥ã€‚æ²¡æœ‰å…¶ä»–çº¦æŸæ¡ä»¶äº†"ï¼‰ï¼Œç³»ç»Ÿæ²¡æœ‰æ­£ç¡®èåˆç¬¬ä¸€è½®çš„ä¿¡æ¯ï¼ˆå¦‚"æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹"ã€"2000äººä»¥å†…"ï¼‰ï¼Œè€Œæ˜¯å°†æ¯æ¬¡è¾“å…¥å½“ä½œç‹¬ç«‹çš„è¯·æ±‚å¤„ç†ã€‚

### å…·ä½“è¡¨ç°

**ç¬¬ä¸€è½®è¾“å…¥**ï¼š
```
æˆ‘æƒ³ä¸ºå³å°†ä¸Šå¸‚çš„æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ç³»åˆ—ç­–åˆ’ä¸€åœºè¥é”€æ´»åŠ¨ã€‚å¸Œæœ›åœˆé€‰2000äººä»¥å†…ï¼Œç›®æ ‡æ˜¯æå‡è¿™æ¬¾æ–°å“çš„ä¸‹å•è½¬åŒ–ç‡ã€‚
```

**ç¬¬äºŒè½®è¾“å…¥**ï¼š
```
ä¸­ç­‰æ¶ˆè´¹åå¥½çš„å°±å¯ä»¥ã€‚æ²¡æœ‰å…¶ä»–çº¦æŸæ¡ä»¶äº†ã€‚
```

**æœŸæœ›ç»“æœ**ï¼š
```json
{
  "business_goal": "æå‡æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ä¸‹å•è½¬åŒ–ç‡",  // ä¿ç•™ç¬¬ä¸€è½®
  "kpi": "conversion_rate",  // ä¿ç•™ç¬¬ä¸€è½®
  "target_audience": {
    "consumption_preference": "ä¸­ç­‰"  // æ–°å¢ç¬¬äºŒè½®
  },
  "size_preference": {"min": "", "max": "2000"},  // ä¿ç•™ç¬¬ä¸€è½®
  "constraints": []
}
```

**å®é™…ç»“æœ**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
```json
{
  "business_goal": "",  // ä¸¢å¤±ï¼
  "kpi": "",  // ä¸¢å¤±ï¼
  "target_audience": {
    "consumption_preference": "ä¸­ç­‰"  // åªæœ‰è¿™ä¸ªæ˜¯å¯¹çš„
  },
  "size_preference": {"min": "", "max": ""},  // ä¸¢å¤±ï¼
  "constraints": []
}
```

## æ ¹æœ¬åŸå› 

è™½ç„¶ç³»ç»Ÿåœ¨æ„å»º `conversation_context` æ—¶åŒ…å«äº†å¯¹è¯å†å²çš„æ–‡æœ¬æ‘˜è¦ï¼Œä½† `intent_recognition_node` å¹¶æ²¡æœ‰ä½¿ç”¨ä¸Šä¸€è½®çš„**ç»“æ„åŒ–æ„å›¾**ï¼ˆ`previous_intent`ï¼‰ä½œä¸ºèåˆçš„åŸºçº¿ã€‚

### é—®é¢˜ç‚¹

1. **åªæœ‰æ–‡æœ¬ä¸Šä¸‹æ–‡ï¼Œæ²¡æœ‰ç»“æ„åŒ–åŸºçº¿**
   - `conversation_context` æ˜¯å¯¹è¯å†å²çš„æ–‡æœ¬æè¿°
   - LLM éœ€è¦ä»æ–‡æœ¬ä¸­"çŒœæµ‹"ä¸Šä¸€è½®çš„ç»“æ„åŒ–æ„å›¾
   - è¿™å¯¼è‡´ä¿¡æ¯ä¸¢å¤±å’Œä¸ä¸€è‡´

2. **prompt æŒ‡ä»¤ä¸å¤Ÿæ˜ç¡®**
   - è™½ç„¶æç¤ºè¯è¦æ±‚"èåˆå†å²ä¿¡æ¯"
   - ä½†æ²¡æœ‰æ˜ç¡®å‘Šè¯‰ LLM ä»å“ªä¸ªå…·ä½“çš„åŸºçº¿å¼€å§‹

3. **æ•°æ®æµæ–­å±‚**
   - `routes.py` å·²ç»ä¼ é€’äº† `previous_intent` åˆ° state
   - ä½† `intent_recognition_node` æ²¡æœ‰ä½¿ç”¨å®ƒ

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ çŠ¶æ€å­—æ®µ (backend/app/agent/state.py)

```python
# ========== å¤šè½®å¯¹è¯æ”¯æŒ ==========
conversation_context: str  # å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆæ–‡æœ¬æ‘˜è¦ï¼‰
previous_intent: UserIntent  # ä¸Šä¸€è½®çš„ç”¨æˆ·æ„å›¾ï¼ˆç”¨äºèåˆï¼‰âœ… æ–°å¢
is_modification: bool  # æ˜¯å¦æ˜¯ä¿®æ”¹ç°æœ‰éœ€æ±‚
```

### 2. ä¿®æ”¹ intent_recognition_node (backend/app/agent/nodes.py)

#### 2.1 è·å–ä¸Šä¸€è½®æ„å›¾

```python
previous_intent = state.get("previous_intent")  # ğŸ”¥ è·å–ä¸Šä¸€è½®çš„ç»“æ„åŒ–æ„å›¾
```

#### 2.2 æ„å»ºå¸¦åŸºçº¿çš„ä¸Šä¸‹æ–‡

```python
if previous_intent:
    # æœ‰å¯¹è¯å†å² - å¤šè½®å¯¹è¯æ¨¡å¼ï¼Œä½¿ç”¨ä¸Šä¸€è½®æ„å›¾ä½œä¸ºåŸºçº¿
    logger.info(f"Multi-turn mode: Using previous intent as baseline")
    logger.info(f"Previous intent: {previous_intent}")

    # å°†ä¸Šä¸€è½®æ„å›¾è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä½œä¸ºèåˆçš„åŸºçº¿
    import json
    previous_intent_json = json.dumps(previous_intent, ensure_ascii=False, indent=2)

    context_section = f"""
{conversation_context}

**å¤šè½®å¯¹è¯æ¨¡å¼ - é‡è¦**ï¼š
è¿™æ˜¯ä¸€ä¸ªå¤šè½®å¯¹è¯ã€‚ä¸Šä¸€è½®æˆ‘ä»¬å·²ç»è¯†åˆ«å‡ºçš„æ„å›¾æ˜¯ï¼š

```json
{previous_intent_json}
```

ç°åœ¨ç”¨æˆ·æä¾›äº†æ–°çš„è¾“å…¥ï¼š"{user_input}"

**ä½ çš„ä»»åŠ¡**ï¼š
1. **ä»¥ä¸Šä¸€è½®æ„å›¾ä¸ºåŸºçº¿**ï¼šå¦‚æœæ–°è¾“å…¥æ²¡æœ‰æåˆ°æŸä¸ªå­—æ®µï¼ˆå¦‚business_goalã€kpiï¼‰ï¼Œä¿ç•™ä¸Šä¸€è½®çš„å€¼
2. **ç´¯ç§¯çº¦æŸæ¡ä»¶**ï¼šå°†æ–°çš„çº¦æŸæ¡ä»¶è¿½åŠ åˆ°constraintsåˆ—è¡¨ä¸­ï¼ˆé™¤éç”¨æˆ·æ˜ç¡®è¯´"å»æ‰"æŸæ¡ä»¶ï¼‰
3. **æ›´æ–°æåˆ°çš„å­—æ®µ**ï¼šå¦‚æœæ–°è¾“å…¥æåˆ°äº†æŸä¸ªç»´åº¦ï¼ˆå¦‚æ¶ˆè´¹åå¥½ã€æ€§åˆ«ï¼‰ï¼Œæ›´æ–°target_audienceä¸­çš„å¯¹åº”å­—æ®µ
4. **è¦†ç›–å†²çªä¿¡æ¯**ï¼šå¦‚æœæ–°è¾“å…¥ä¸å†å²å†²çªï¼ˆå¦‚ä¹‹å‰è¯´"VIP"ï¼Œç°åœ¨è¯´"VVIP"ï¼‰ï¼Œä»¥æ–°è¾“å…¥ä¸ºå‡†

**å…³é”®**ï¼šä¸è¦ä»å¤´æ„å»ºæ„å›¾ï¼ä»ä¸Šé¢çš„previous_intentå¼€å§‹ï¼Œæ ¹æ®æ–°è¾“å…¥è¿›è¡Œå¢é‡æ›´æ–°ã€‚
"""
```

#### 2.3 æ›´æ–° Prompt æŒ‡ä»¤

```python
prompt = f"""{context_section}ä½ æ˜¯ä¸€ä¸ªè¥é”€ä¸“å®¶ï¼Œè´Ÿè´£åˆ†æç”¨æˆ·çš„åœˆäººéœ€æ±‚ã€‚

{"**é‡è¦æé†’**ï¼šè¿™æ˜¯å¤šè½®å¯¹è¯ï¼Œä½ å¿…é¡»åœ¨ä¸Šä¸€è½®æ„å›¾çš„åŸºç¡€ä¸Šè¿›è¡Œå¢é‡æ›´æ–°ï¼Œè€Œä¸æ˜¯ä»é›¶å¼€å§‹ã€‚" if previous_intent else ""}

è¯·åˆ†æ{"ç”¨æˆ·çš„æ–°è¾“å…¥ï¼Œå¹¶æ›´æ–°æ„å›¾" if previous_intent else "ç”¨æˆ·çš„æ„å›¾"}ï¼Œå¹¶è¿”å›JSONæ ¼å¼çš„ç»“æœï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

- business_goal: ä¸šåŠ¡ç›®æ ‡{"- å¦‚æœæ–°è¾“å…¥æœªæåŠï¼Œä¿ç•™ä¸Šä¸€è½®çš„å€¼" if previous_intent else ""}
- target_audience: ç›®æ ‡äººç¾¤æè¿°{"- åªæ›´æ–°æ–°è¾“å…¥æåˆ°çš„å­—æ®µï¼Œå…¶ä»–å­—æ®µä¿ç•™ä¸Šä¸€è½®çš„å€¼" if previous_intent else ""}
- constraints: æ‰€æœ‰çš„çº¦æŸæ¡ä»¶åˆ—è¡¨{"- åœ¨ä¸Šä¸€è½®çš„åŸºç¡€ä¸Šè¿½åŠ æ–°çº¦æŸ" if previous_intent else ""}
- kpi: æ ¸å¿ƒKPI{"- å¦‚æœæ–°è¾“å…¥æœªæåŠï¼Œä¿ç•™ä¸Šä¸€è½®çš„å€¼" if previous_intent else ""}
- size_preference: äººç¾¤è§„æ¨¡åå¥½{"- å¦‚æœæ–°è¾“å…¥æœªæåŠï¼Œä¿ç•™ä¸Šä¸€è½®çš„å€¼" if previous_intent else ""}

{"**å†æ¬¡å¼ºè°ƒ**ï¼šä½ å¿…é¡»ä»¥ä¸Šé¢æä¾›çš„previous_intentä¸ºèµ·ç‚¹ï¼Œæ ¹æ®æ–°è¾“å…¥è¿›è¡Œå¢é‡ä¿®æ”¹ã€‚ä¸è¦ä¸¢å¤±ä»»ä½•å†å²ä¿¡æ¯ï¼" if previous_intent else ""}
"""
```

#### 2.4 æ·»åŠ èåˆæ—¥å¿—

```python
# ğŸ”¥ å¦‚æœæ˜¯å¤šè½®å¯¹è¯ï¼Œè®°å½•èåˆæƒ…å†µ
if previous_intent:
    logger.info("=" * 50)
    logger.info("Multi-turn Intent Merge Report:")
    logger.info(f"  Previous business_goal: {previous_intent.get('business_goal', 'N/A')}")
    logger.info(f"  New business_goal: {response.get('business_goal', 'N/A')}")
    logger.info(f"  Previous constraints: {previous_intent.get('constraints', [])}")
    logger.info(f"  New constraints: {response.get('constraints', [])}")
    logger.info(f"  Previous kpi: {previous_intent.get('kpi', 'N/A')}")
    logger.info(f"  New kpi: {response.get('kpi', 'N/A')}")
    logger.info("=" * 50)
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
ç”¨æˆ·ç¬¬1è½®: æˆ‘æƒ³ä¸ºæ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ç­–åˆ’è¥é”€æ´»åŠ¨ï¼Œ2000äººä»¥å†…
â†’ business_goal: "æå‡æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹è½¬åŒ–ç‡", kpi: "conversion_rate", size_preference: {max: 2000}

ç”¨æˆ·ç¬¬2è½®: ä¸­ç­‰æ¶ˆè´¹åå¥½çš„å°±å¯ä»¥
â†’ business_goal: "", kpi: "", size_preference: {}  âŒ ä¿¡æ¯ä¸¢å¤±ï¼
```

### ä¿®å¤å

```
ç”¨æˆ·ç¬¬1è½®: æˆ‘æƒ³ä¸ºæ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ç­–åˆ’è¥é”€æ´»åŠ¨ï¼Œ2000äººä»¥å†…
â†’ business_goal: "æå‡æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹è½¬åŒ–ç‡", kpi: "conversion_rate", size_preference: {max: 2000}

ç”¨æˆ·ç¬¬2è½®: ä¸­ç­‰æ¶ˆè´¹åå¥½çš„å°±å¯ä»¥
â†’ business_goal: "æå‡æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹è½¬åŒ–ç‡" âœ… ä¿ç•™
   kpi: "conversion_rate" âœ… ä¿ç•™
   size_preference: {max: 2000} âœ… ä¿ç•™
   target_audience: {consumption_preference: "ä¸­ç­‰"} âœ… æ–°å¢
```

## æµ‹è¯•æ­¥éª¤

### 1. é‡å¯åç«¯

```bash
cd backend
# åœæ­¢å½“å‰è¿è¡Œçš„åç«¯ (Ctrl+C)
python main.py
```

### 2. åˆ·æ–°å‰ç«¯

åœ¨æµè§ˆå™¨ä¸­æŒ‰ `Ctrl+Shift+R` ç¡¬åˆ·æ–°

### 3. æ‰§è¡Œæµ‹è¯•å¯¹è¯

**ç¬¬1è½®**ï¼š
```
æˆ‘æƒ³ä¸ºå³å°†ä¸Šå¸‚çš„æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ç³»åˆ—ç­–åˆ’ä¸€åœºè¥é”€æ´»åŠ¨ã€‚å¸Œæœ›åœˆé€‰2000äººä»¥å†…ï¼Œç›®æ ‡æ˜¯æå‡è¿™æ¬¾æ–°å“çš„ä¸‹å•è½¬åŒ–ç‡ã€‚
```

**ç¬¬2è½®**ï¼š
```
ä¸­ç­‰æ¶ˆè´¹åå¥½çš„å°±å¯ä»¥ã€‚æ²¡æœ‰å…¶ä»–çº¦æŸæ¡ä»¶äº†ã€‚
```

### 4. æ£€æŸ¥åç«¯æ—¥å¿—

åº”è¯¥çœ‹åˆ°ï¼š

```
INFO: Calling LLM for intent recognition (multi-turn: True)
INFO: Multi-turn mode: Using previous intent as baseline
INFO: Previous intent: {'business_goal': 'æå‡æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ä¸‹å•è½¬åŒ–ç‡', 'kpi': 'conversion_rate', ...}
INFO: ==================================================
INFO: Multi-turn Intent Merge Report:
INFO:   Previous business_goal: æå‡æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ä¸‹å•è½¬åŒ–ç‡
INFO:   New business_goal: æå‡æ˜¥å­£æ–°æ¬¾æ‰‹è¢‹ä¸‹å•è½¬åŒ–ç‡  âœ… ä¿ç•™äº†ï¼
INFO:   Previous constraints: []
INFO:   New constraints: []
INFO:   Previous kpi: conversion_rate
INFO:   New kpi: conversion_rate  âœ… ä¿ç•™äº†ï¼
INFO: ==================================================
```

### 5. éªŒè¯ç»“æœ

ç¬¬äºŒè½®çš„æ„å›¾åº”è¯¥åŒ…å«ï¼š
- âœ… business_goal ä¿ç•™ç¬¬ä¸€è½®çš„å€¼
- âœ… kpi ä¿ç•™ç¬¬ä¸€è½®çš„å€¼
- âœ… size_preference ä¿ç•™ç¬¬ä¸€è½®çš„å€¼
- âœ… target_audience å¢åŠ äº† consumption_preference

## ç›¸å…³æ–‡ä»¶

### å·²ä¿®æ”¹

1. **backend/app/agent/state.py** (Line 69-72)
   - æ·»åŠ  `conversation_context`ã€`previous_intent`ã€`is_modification` å­—æ®µ

2. **backend/app/agent/nodes.py** (Line 33-142)
   - è·å– `previous_intent` å¹¶ä½¿ç”¨å®ƒä½œä¸ºåŸºçº¿
   - æ„å»ºå¸¦æœ‰ç»“æ„åŒ–åŸºçº¿çš„ä¸Šä¸‹æ–‡
   - æ›´æ–° prompt æŒ‡ä»¤å¼ºè°ƒå¢é‡æ›´æ–°
   - æ·»åŠ èåˆæ—¥å¿—

### å·²å­˜åœ¨ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

3. **backend/app/api/routes.py** (Line 228)
   - å·²ç»åœ¨ä¼ é€’ `previous_intent` åˆ° state

4. **backend/app/core/session.py** (Line 76-82)
   - å·²ç»åœ¨ä¿å­˜ `latest_intent` åˆ° `current_context`

## æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆéœ€è¦ç»“æ„åŒ–åŸºçº¿ï¼Ÿ

1. **ç»“æ„åŒ–æ•°æ®æ›´å‡†ç¡®**
   - æ–‡æœ¬æ‘˜è¦å¯èƒ½é—æ¼ç»†èŠ‚
   - JSON ç»“æ„ä¿è¯å®Œæ•´æ€§

2. **æ˜ç¡®çš„èåˆèµ·ç‚¹**
   - LLM çŸ¥é“ä»å“ªé‡Œå¼€å§‹
   - å‡å°‘çŒœæµ‹å’Œè¯¯è§£

3. **å¢é‡æ›´æ–°æ¨¡å¼**
   - åªä¿®æ”¹å˜åŒ–çš„éƒ¨åˆ†
   - ä¿ç•™æœªæåŠçš„å­—æ®µ

### ä¸ºä»€ä¹ˆä¹‹å‰çš„æ–¹æ¡ˆä¸å¤Ÿï¼Ÿ

ä¹‹å‰åªæœ‰ `conversation_context`ï¼ˆæ–‡æœ¬æ‘˜è¦ï¼‰ï¼Œä½†ï¼š
- LLM éœ€è¦ä»æ–‡æœ¬ä¸­é‡æ–°è§£æç»“æ„
- å®¹æ˜“ä¸¢å¤±å­—æ®µå€¼
- ä¸åŒçš„è§£æå¯èƒ½ä¸ä¸€è‡´

ç°åœ¨æœ‰äº† `previous_intent`ï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰ï¼ŒLLM å¯ä»¥ï¼š
- ç›´æ¥ä½¿ç”¨ä¸Šä¸€è½®çš„å®Œæ•´ç»“æ„
- åªæ›´æ–°æ–°è¾“å…¥æåˆ°çš„å­—æ®µ
- ç¡®ä¿ä¿¡æ¯è¿ç»­æ€§

## æˆåŠŸæ ‡å¿—

å½“ä¿®å¤æˆåŠŸæ—¶ï¼Œå¤šè½®å¯¹è¯åº”è¯¥è¡¨ç°ä¸ºï¼š

1. **ä¿¡æ¯ç´¯ç§¯**
   - æ¯ä¸€è½®çš„ä¿¡æ¯éƒ½è¢«ä¿ç•™
   - æ–°è¾“å…¥è¡¥å……è€Œä¸æ˜¯æ›¿æ¢

2. **çº¦æŸè¿½åŠ **
   - constraints åˆ—è¡¨é€æ­¥å¢é•¿
   - é™¤éç”¨æˆ·æ˜ç¡®è¯´"å»æ‰"

3. **å­—æ®µä¿ç•™**
   - æœªæåŠçš„å­—æ®µä¿æŒä¸å˜
   - business_goalã€kpi ç­‰æ ¸å¿ƒå­—æ®µæŒç»­å­˜åœ¨

4. **æ—¥å¿—æ¸…æ™°**
   - åç«¯æ—¥å¿—æ˜¾ç¤º "Multi-turn mode: Using previous intent as baseline"
   - Merge Report æ˜¾ç¤ºå­—æ®µå¯¹æ¯”
